{% extends "philadelphia/base.html" %}
{% block nav_twitter %}{% endblock nav_twitter %}
{% block nav_search %}
<li class="nav-search">
<form action="" method="post">{% csrf_token %}
		{{ form.as_p }}
		<button class="primary" type="submit" value="Continue">Search</button>
	</form>
</li>
{% endblock nav_search %}
{% block layout %}
<div class="page-content" style="position:relative; top:100px">
	<div id="map" style="height:600px; width: 100%">
    </div>
    <div id="map-status" class="status" style="display:none">
        Loading Map Features...
    </div>
</div>
{% endblock layout %}
{% block js_local %}
<script src="{{ STATIC_URL }}js/libs/leaflet-plugins/layer/tile/Bing.js"></script>
<script>
    // Initialize the map object
    var map = new L.Map('map', {
        zoomControl: false,
        doubleClickZoom: false,
        maxZoom: 21,
        minZoom: 11
    });
    
    // Prep the background tile layer
    var tileUrl = 'http://api.tiles.mapbox.com/v3/dmeehan.map-sued82zn/{z}/{x}/{y}.png';
    var tileAttribution = '';
    
    var satellite = new L.BingLayer("Anqm0F_JjIZvT0P3abS6KONpaBaKuTnITRrnYuiJCE0WOhH6ZbE4DzeT6brvKVR5");

    var streets = L.tileLayer(tileUrl, {
        attribution: tileAttribution,
    });
    
    
    // Set the center on Philadelphia
    var philadelphia = new L.LatLng(39.9522, -75.1642);
    map.setView(philadelphia, 15);
    
    map.addLayer(satellite);
    
    var lotStyle = {
        "fillColor":"#e8db00",
        "fillOpacity": 0.2,
        "opacity": 1.0,
        "weight": 2,
        "color":"#e8db00",
    };

    var lotLayer = L.geoJson(null, {
                    onEachFeature: function(feature, layer) {
                        url = '{% url "lot_detail" 0 %}'.replace (0, feature.properties.id);
                        html = '<p><strong><a href="' + url + '">' 
                               + feature.properties.address 
                               + '</a></strong></p>';        
                        layer.bindPopup(html);
                        layer.setStyle(lotStyle);
                    },
                });
    
    $.getJSON('{% url "search" %}?format=json', function(data){
          lotLayer.addData(data.features).addTo(map);
          $('#map-status').fadeOut('slow');
          map.fitBounds(lotLayer.getBounds());
    });
    
    map.on('zoomend', onZoomend);

    function onZoomend(){
       if (map.getZoom()>=17) {
           map.removeLayer(streets);
           map.addLayer(satellite);
       };

       if(map.getZoom()<17){
           map.removeLayer(satellite);
           map.addLayer(streets);
       };

    };
</script>
{% endblock js_local %}