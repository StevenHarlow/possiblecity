  {% extends "lotxlot/map.html" %}

  {% load staticfiles %}
  {% load humanize %}
  {% load i18n %}
  {% load floppyforms %}
  {% load phileo_tags %}
  {% load thumbnail %}
  {% load possiblecity_tags %}
  {% load comment_tags %}
  {% load activity_tags %}
  

  {% block head_title %}Lot #{{ lot.id }} | {{ lot.address }} {% endblock head_title %}

  {% block map %}
    <div id="map" class="minimize"></div>
  {% endblock map %}

 {% block body %}
  <div class="container lot-detail">
    <div class="panel">
      <header class="lot-header row">
        <div class="col-md-12">
          <div class="lot-detail-page-container-icons">
            <a href="#" title="Minimize/Maximize" class="lot-control minmax icon-angle-down pull-right"></a> 
          </div>
          <div>
            <h1>
               <a href="#" data-toggle="tooltip" title="Reset location" class="lot-control reset-location icon-map-marker icon-border"></a> Lot #{{ lot.id }} - {{ lot.address }}
            </h1>
          </div>
          <div class="action-buttons col-xs-12 col-md-4">
              <span class="pull-right">
              {% if request.user.is_authenticated %}
              {% phileo_widget_brief request.user lot %}
              {% else %}
              <span class="phileo">
                <a data-toggle="modal" data-target="#login-modal" href="#login-modal" class="btn btn-primary top-right-btn">Like</a>
              </span>
              {% endif %}
              </span>
              <div class="actstream">
                <a class="btn btn-primary pull-right ajax" 
                   href="{% follow_all_url lot %}"
                   data-method="post"
                   data-replace-closest=".actstream"
                   data-spinner="off">
                  {% if request.user|is_following:lot %}
                    <i class="icon-ok-sign"></i> {% trans 'Following' %}
                  {% else %}
                    <i class="icon-plus"></i> {% trans 'Follow' %}
                  {% endif %}
                </a>
              </div>
        </div>
      </header>
      <section class="lot-info row">
        <div class="col-lg-6 col-md-6">
            <img class="lot-image-lot-detail-page" src="http://maps.googleapis.com/maps/api/streetview?size=800x400&location={{ lot.coord.y }},{{ lot.coord.x}}&sensor=false&fov=105">
        </div>
        <div class="col-lg-6 col-md-6">
          <ul class="nav nav-pills">
            <li class="active"><a href="#vacancy" data-toggle="tab">Vacancy</a></li>
            <li><a href="#ownership" data-toggle="tab">Owner</a></li>
            <li><a href="#political" data-toggle="tab">Spatial</a></li>
            <li><a href="#financial" data-toggle="tab">Financial</a></li>
            <li><a href="#environmental" data-toggle="tab">Environmental</a></li>
          </ul>

          <!-- Tab panes -->
          <div class="tab-content">
            <div class="tab-pane active" id="vacancy">
              <table class="table">
                <tbody>
                  <tr>
                    <th>Listed For Sale By City:</th>
                    <td>
                    {% if lot.profile.is_for_sale %}
                        <i class="icon-ok-sign positive"></i>&nbsp;&nbsp;
                        {{ lot.profile.papl_listing.PRICE_STR }}
                    {% else %}
                        <i class="icon-minus-sign negative"></i>
                        {% if lot.is_public %}
                          &nbsp;&nbsp;Not For Sale
                        {% else %}&nbsp;&nbsp;Not Applicable
                        {% endif %}
                    {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <th>Vacancy Violation:</th>
                    <td>{% if lot.profile.has_violation %}
                        <i class="icon-ok-sign positive"> </i>
                        &nbsp;&nbsp;{{ lot.profile.latest_violation.DESCRIPTION }}
                        {% else %}
                        <i class="icon-minus-sign negative"></i> &nbsp;&nbsp;None
                        {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <th>Violation Non-Compliance:</th>
                    <td>
                    {% if lot.profile.is_non_compliant %}
                      <i class="icon-ok-sign positive"></i> &nbsp;&nbsp;Not Complied
                    {% else %}
                      <i class="icon-minus-sign negative"></i>
                      {% if lot.profile.has_violation %} &nbsp;&nbsp;Complied {% else %} &nbsp;&nbsp;Not Applicable {% endif %}
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <th>Vacancy License:</th>
                    <td>
                      {% if lot.profile.get_licenses %}
                      <i class="icon-ok-sign positive"></i>
                        &nbsp;&nbsp;{{ lot.profile.latest_license.DESCRIPTION }}
                      {% else %}
                      <i class="icon-minus-sign negative"></i> &nbsp;&nbsp;None
                      {% endif %}
                      </td>
                  </tr>
                  <tr>
                    <th>Land Use:</th>
                    <td>
                        {% if lot.profile.is_land_use_vacant %}
                        <i class="icon-ok-sign positive"></i>
                        {% else %}
                        <i class="icon-minus-sign negative"></i>
                        {% endif %}&nbsp;&nbsp;{{ lot.profile.land_use }}</td>
                  </tr>
                  <tr>
                    <th>Building Description:</th>
                    <td>
                    {% if lot.profile.is_bldg_desc_vacant %}
                      <i class="icon-ok-sign positive"></i>
                    {% else %}
                      <i class="icon-minus-sign negative"></i>
                    {% endif %}&nbsp;&nbsp;{{ lot.profile.building_description }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="tab-pane" id="ownership">
              <table class="table">
                <tbody>
                  <tr>
                    <th>Ownership:</th>
                    <td>{% if lot.is_public %}Public{% else %}Private{% endif %}</td>
                  </tr>
                  <tr>
                    <th>Owner:</th>
                    <td>{{ lot.profile.owner }}</td>
                  </tr>
                  <tr>
                    <th>Mailing Address:</th>
                    <td>{{ lot.profile.account_mailing_address.street.0 }}<br>
                      {{ lot.profile.account_mailing_address.street.1 }}<br>
                      {{ lot.profile.account_mailing_address.city }}, {{ lot.profile.account_mailing_address.state }}
                      {{ lot.profile.account_mailing_address.zip }}
                    </td>
                  </tr>
                  <tr>
                    <th>Owner Since:</th>
                    <td>{{ lot.profile.account_details.sale_date }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="tab-pane" id="political">
              <table class="table">
                <tbody>
                  <tr>
                    <th>Size:</th>
                    <td>{{ lot.get_sqft|floatformat:0 }} sq. ft. ({{ lot.get_acres|floatformat:2 }} acres)</td>
                  </tr>
                  <tr>
                    <th>Neighborhood:</th>
                    <td>{{ lot.profile.neighborhood }}</td>
                  </tr>
                  <tr>
                    <th>Zoning Designation:</th>
                    <td>{{ lot.profile.zoning_base }}: {{ lot.profile.account_details.zoning_desc }}</td>
                  </tr>
                  {% if lot.profile.zoning_overlay %}
                  <tr>
                    <th>Zoning Overlay:</th>
                    <td>
                      <a title="American Legal Code Section" href="{{ lot.profile.zoning_overlay.CODE_SECTION_LINK }}">
                        {{ lot.profile.zoning_overlay.OVERLAY_NAME }}
                      </a>
                    </td>
                  </tr>
                  {% endif %}
                  <tr>
                    <th>Council District:</th>
                    <td>District {{ lot.profile.council_district.DIST_NUM }}</td>
                  </tr>
                  <tr>
                    <th>Planning District:</th>
                    <td>District {{ lot.profile.planning_district.DIST_NUM }}: {{ lot.profile.planning_district.DIST_NAME }}</td>
                  </tr>
                  <tr>
                    <th>Census:</th>
                    <td>{{ lot.profile.census.NAMELSAD10 }} {{ lot.profile.blockgroup.NAMELSAD10 }} </td>
                  </tr>
                  <tr>
                    <th>Ward:</th>
                    <td>Ward {{ lot.profile.ward.WARD_NUM }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="tab-pane" id="financial">
              <table class="table">
                <tbody>
                  <tr>
                    <th>BRT/OPA Account #:</th>
                    <td><a href="http://opa.phila.gov/opa.apps/Search/SearchResults.aspx?id={{ lot.profile.tencode}}">{{ lot.profile.brt_id }}</a></td>
                  </tr>
                  <tr>
                    <th>Last Sale Price:</th>
                    <td>{{ lot.profile.account_details.sale_price }}</td>
                  </tr>
                  <tr>
                    <th>Sale Date:</th>
                    <td>{{ lot.profile.account_details.sale_date }}
                    </td>
                  </tr>
                  <tr>
                    <th>Market Value:</th>
                    <td>{{ lot.profile.account_valuation.market_value }}
                    </td>
                  </tr>
                  <tr>
                    <th>Assessed Land Taxable:</th>
                    <td>{{ lot.profile.account_valuation.assessed_land_taxable }}
                    </td>
                  </tr>
                  <tr>
                    <th>Assessed Improvement Taxable:</th>
                    <td>{{ lot.profile.account_valuation.assessed_improvement_taxable }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="tab-pane" id="environmental">
              <table class="table">
                <tbody>
                  <tr>
                    <th>Impervious Area:</th>
                    <td>{{ lot.profile.impervious_area }}</td>
                  </tr>
                  <tr>
                    <th>100 Year Flood Plain:</th>
                    <td>
                      {% if lot.profile.get_zoning_flood %}
                        <i class="icon-ok-sign positive"></i>
                      {% else %}
                        <i class="icon-minus-sign negative"></i>
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <th>Steep Slopes:</th>
                    <td>
                      {% if lot.profile.get_zoning_slope %}
                        <i class="icon-ok-sign positive"></i>
                      {% else %}
                        <i class="icon-minus-sign negative"></i>
                      {% endif %}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
      <hr>
      <section class="actions row">
        <div class="col-lg-6 col-md-6">
          <h2>Comments <small>{% comment_count lot %}</small></h2>
          <ul class="list-group">
            <div class="nav-tab-button text-center"></div>
            <li class="list-group-item">
              <div class="media"> 
                <span class="pull-left profile-img">            
                  <img class="media-object"  
                  alt="{{ request.user }}" 
                  {% if request.user.profile.photo %}
                  src="{{ request.user.profile.photo.url }}" 
                  {% else %}
                  src="{% static 'img/profile.png' %}"
                  {% endif %} 
                  style="width: 64px; height: 64px;" />
                </span>
                <div class="media-body">
                  {% comment_form lot as comment_form %}
                  <form method="post" id="comment-form" action=".">
                    {% csrf_token %}
                    {{ comment_form }}
                    <div class="form-actions">
                      <button type="submit" class="btn btn-primary pull-right">{% trans "Add your comment" %}
                      </button>
                    </div>
                  </form> 
                </div>
              </div>
            </li>
            {% comments lot as comments %}
            {% for comment in comments %}
            <li class="list-group-item" id="comment-{{ comment.id }}">
              <div class="media"> 
              {% if comment.user.profile.is_public %}
                <a class="pull-left profile-img" href="{{ comment.user.profile.get_absolute_url }}">
              {% else %}
                <span class="pull-left profile-img">
              {% endif %}                    
                  <img class="media-object"  
                  alt="{{ comment.user }}" 
                  {% if comment.user.profile.photo %}
                  src="{{ comment.user.profile.photo.url }}" 
                  {% else %}
                  src="{% static 'img/profile.png' %}"
                  {% endif %} 
                  style="width: 64px; height: 64px;" />
              {% if comment.user.profile.is_public %}
                </a>
              {% else %}
                </span>
              {% endif %}
                <div class="media-body">
                  <h4 class="media-heading">
                    {{ comment.user.profile.full_name }}
                  </h4>
                  {% if comment.image %}
                  <img src="{% thumbnail comment.image '300x150' crop %}" alt="{{ comment.text }}" />
                  {% endif %}
                  <p>{{ comment.text }}</p>
                  <h6>Via {{ comment.get_via_display }}
                      {% if comment.get_via_display == "Twitter" %}
                      <i class="icon-twitter"></i>
                      {% elif comment.get_via_display == "Text" %}
                      <i class="icon-mobile-phone"></i>
                      {% elif comment.get_via_display == "Web" %}
                      <i class="icon-globe"></i>
                      {% elif comment.get_via_display == "Instagram" %}
                      <i class="icon-instagram"></i>
                      {% endif %}
                      &nbsp;•&nbsp; {{ comment.created }}
                      {% if request.user.is_authenticated %}
                          &nbsp;•&nbsp; {% phileo_widget request.user comment %}
                      {% else %}
                      <span class="phileo">
                          &nbsp;•&nbsp;
                          <a data-toggle="modal" data-target="#login-modal" href="#login-modal">
                            Like
                          </a>
                          &nbsp;•&nbsp;
                          <i class="{% if comment|likes_count > 0 %}icon-heart{% else %}icon-heart-empty{% endif %}"></i>
                          <span class="count">
                              {{ comment|likes_count }}
                          </span>
                      </span>
                      {% endif %}
                    </h6>
                </div>
              </div>
            </li>
            {% endfor %}
          </ul>    
          </div>
        <div class="col-lg-6">
          <div class="lot-detail-page-projects">
            <h2>Projects <small>{{ lot.idea_count }}</small></h2>
            <p class="margin-bottom-15">Ongoing activity to generate a new use for this lot.</p>
            <a href="#" class="btn btn-primary pull-right start-project-btn">+ Start a Project</a>
            <ul class="list-group">
               {% for idea in lot.idea_set.all %}
                  <li class="list-group-item" id="idea-{{ idea.id }}">
                    <div class="media">           
                    {% if idea.get_lead_image %}
                        <a class="pull-left" href="{{ idea.get_absolute_url }}">
                          <img src="{% thumbnail idea.get_lead_image.file '128x128' crop %}" alt="{{ idea.title }}" />
                        </a>
                    {% else %}
                      <a class="pull-left" href="{{ idea.get_absolute_url }}">
                        <img class="lot-image-lot-detail-page" src="http://maps.googleapis.com/maps/api/streetview?size=128x128&location={{ lot.coord.y }},{{ lot.coord.x}}&sensor=false&fov=105">
                      </a>
                    {% endif %}
                      <div class="media-body">
                        <a href="{{ idea.get_absolute_url }}">
                          <h4 class="media-heading">
                            {% if idea.title %}
                              {{ idea.title }}

                            {% else %}
                              Untitled Project
                            {% endif %}
                          </h4>
                        </a> 
                        <p>{{ idea.tagline }}</p>
                        <h6>
                          <a href="{{ idea.user.profile.get_absolute_url }}">
                          {% if idea.user.first_name %}
                            {{ idea.user.profile.full_name }}
                          {% else %}
                             {{ idea.user.username }}
                          {% endif %}
                          </a> 
                          Via {{ idea.get_via_display }}
                            {% if idea.get_via_display == "Twitter" %}
                            <i class="icon-twitter"></i>
                            {% elif idea.get_via_display == "Text" %}
                            <i class="icon-mobile-phone"></i>
                            {% elif idea.get_via_display == "Web" %}
                            <i class="icon-globe"></i>
                            {% elif idea.get_via_display == "Instagram" %}
                            <i class="icon-instagram"></i>
                            {% endif %}
                            &nbsp;•&nbsp; {{ idea.floated|ago }}
                            &nbsp;•&nbsp;
                            <a href="{{ idea.get_absolute_url }}">
                              View
                            </a>
                            {% if request.user.is_authenticated %}
                                &nbsp;•&nbsp; {% phileo_widget request.user idea %}
                            {% else %}
                            <span class="phileo">
                                &nbsp;•&nbsp;
                                <a data-toggle="modal" data-target="#login-modal" href="#login-modal">
                                  Like
                                </a>
                                &nbsp;•&nbsp;
                                <i class="{% if idea|likes_count > 0 %}icon-heart{% else %}icon-heart-empty{% endif %}"></i>
                                <span class="count">
                                    {{ idea|likes_count }}
                                </span>
                            </span>
                            {% endif %}
                          </h6>
                      </div>
                    </div>
                  </li>
                  {% endfor %}        
                </ul>
          </div>
          <div class="people">
            <h2>People <small>{{ lot|likes_count}}</small></h2>
            <p class="margin-bottom-15">Organizers on this lot.</p>
            {% if request.user.is_authenticated %}
              {% phileo_widget_brief request.user lot %}
            {% else %}
              <span class="phileo">
                  <a data-toggle="modal" data-target="#login-modal" href="#login-modal" class="btn btn-primary pull-right start-project-btn">+ Follow this Lot</a>
              </span>
            {% endif %}

            {% who_likes lot as lot_likes %}
            {% if lot_likes %}
            <div class="row">
              {% for like in lot_likes %}
                  <div class="col-lg-2">
                      {% if like.sender.profile.is_public %}
                      <a href="{% url 'profiles_profile_detail' like.sender.username %}">
                      {% endif %}
                      <img class="profile-pic"
                      {% if like.sender.profile.photo %}
                          src="{% thumbnail like.sender.profile.photo '200x200' crop upscale %}"
                      {% else %}
                          src="{% static 'img/profile.png' %}"
                      {% endif %}
                      {% if like.sender.first_name %}
                          alt="{{ like.sender.profile.full_name }}"
                          title="{{ like.sender.profile.full_name }}"
                      {% else %}
                          alt="{{ like.sender.username }}"
                          title="{{ like.sender.username }}"
                      {% endif %}
                      >
                      {% if like.sender.profile.is_public %}
                      </a>
                      {% endif %}
                  </div>
              {% endfor %}
              </div>
              {% endif %}
            
          </div>

        </section>


  </div><!-- .panel -->
  </div> <!-- .container -->
  {% endblock body %}

  {% block extra_map_js %}
  <script>
      var lot = L.geoJson(null, {
         style: parcelStyle
      }).addTo(map);
          

      var lot_url = '{% url "api-lot-detail" lot.id %}' + '?format=json';

      $.getJSON(lot_url, function(data){
        map.fire('dataloading');
        lot.addData(data);
        var center = new L.LatLng({{ lot.coord.y }}, {{ lot.coord.x }});
        var bounds = lot.getBounds();
        map.fitBounds(bounds, {
        maxZoom:19,
        padding:20
      });

      var ownership = {% if lot.is_public %}"Public"{% else %}"Private"{% endif %}
      var ownership_icon = {% if lot.is_public %}"icon-unlock-alt"{% else %}"icon-lock"{% endif %}

      var content = '<center><h3><i class="icon-map-marker"></i> {{ lot.address }}</h3>' +
                    '<i class="icon-large ' + ownership_icon + '">&nbsp;</i> <strong>'  + ownership + '</strong>&nbsp;&nbsp;&nbsp;&nbsp;' +
                    '<i class="icon-resize-full icon-large ">&nbsp;</i> <strong>{{ lot.get_sqft|floatformat:0 }} sq. ft.</strong>&nbsp;&nbsp;&nbsp;&nbsp;' +
                    '<i class="icon-lightbulb icon-large">&nbsp;</i> <strong>{{ lot.idea_set.count }}</strong>&nbsp;&nbsp;&nbsp;&nbsp;</center>';

      content = "";

      var labelIcon = L.divIcon({className: 'leaflet-label leaflet-label-selected', html: content,  iconSize:null});

      L.marker(center, {riseOnHover: true}).addTo(map);

      map.fire('dataload');
      map.removeLayer(neighborhoods);
      });

      $('.lot-control').tooltip();

      $( ".reset-location" ).click(function() {
        var center = new L.LatLng({{ lot.coord.y }}, {{ lot.coord.x }});
        map.setView(center, map.getZoom())
      });
     
      $( "a.minmax" ).click(function() {
        $(this).toggleClass("icon-angle-up");
        $(this).toggleClass("icon-angle-down")
        $("#map").toggleClass("maximize");
        $("#map").toggleClass("minimize");

        map.invalidateSize({
          animate: true,
          debounceMoveend: true,
          duration: 0.5,
        });
      });

  </script>
  {% endblock extra_map_js %}
