{% extends "lotxlot/map_base.html" %}

{% load staticfiles %}
{% load humanize %}
{% load i18n %}
{% load floppyforms %}
{% load possiblecity_tags %}

{% block head_title %}Lot {{ lot.address }} {% endblock head_title %}
{% block body %}
<style>
.idea-label, .idea-label-selected {
  background:transparent;
  border:none;
  top: -35px;
  left: -20px;
  text-align: center;
}

.idea-label a, .idea-label-selected a {
  text-decoration:none;
}

.idea-label i, .idea-label h4, .idea-label-selected i {
  color: #cd00cd;
}

.idea-label-selected h4 {
  color: #fff;
}

.idea-label h4, .idea-label-selected h4 {
  position: absolute; 
  left: 24px; 
  top: 4px;
}

.idea-label:before, .idea-label-selected:before {
  border:none;
}
</style>
    <div class="sidebar ideas-lot-info-sidebar">
        <div class="close-button pull-right">
            <a href="#" type="button" class="close ">&times;</a>
         </div>
        <header class="lot-id-header text-center">
            <h1>Lot #{{ lot.id }}</h1>
            <h2>{{ lot.address }}</h2>
        </header>
        <ul id="sidebar-tabs" class="nav nav-tabs">
          <li class="active"><a href="#ideas" data-toggle="tab">Ideas</a></li>
          <li class=""><a href="#info" data-toggle="tab">Info</a></li>
        </ul>

        <div id="sidebar-tabs-content" class="tab-content">
          <div class="tab-pane fade active in" id="ideas">
            <div class="activity">
                <ul class="list-group">
                  <div class="nav-tab-button text-center"></div>
                  <li class="list-group-item">
                    <div class="media">
                     {% if request.user.is_authenticated %}
                      <a class="pull-left profile-img" href="{{ request.user.profile.get_absolute_url }}">
                      <img class="media-object"  
                           {% if request.user.profile.photo %}
                           src="{{ request.user.profile.photo.url }}"
                           {% else %}
                           src="{% static 'img/profile.png' %}"
                           {% endif %}
                           alt="64x64" 
                           style="width: 64px; height: 64px;" />
                      </a>
                      {% else %}
                      <span class="pull-left profile-img">
                      <img class="media-object"
                           alt="64x64"
                           src="{% static 'img/profile.png' %}" 
                           style="width: 64px; height: 64px;" />
                      </span>
                      {% endif %}
                      <div class="media-body">
                        <form method="post" id="idea-form" action=".">
                          {% csrf_token %}
                          {{ form }}
                          <div class="form-actions">
                            <button type="submit" class="btn btn-primary pull-right">{% trans "Add idea" %}</button>
                          </div>
                          </form> 
                      </div>
                    </div>
                  </li>
                  {% for idea in lot.idea_set.all %}
                  <li class="list-group-item">
                    <div class="media">
                      <a class="pull-left profile-img" href="{{ idea.user.profile.get_absolute_url }}">
                        <img class="media-object"  
                        alt="64x64" 
                        {% if idea.user.profile.photo %}
                        src="{{ idea.user.profile.photo.url }}" 
                        {% else %}
                        src="{% static 'img/profile.png' %}"
                        {% endif %} 
                        style="width: 64px; height: 64px;" />
                      </a>
                      <div class="media-body">
                        <h4 class="media-heading">
                        {% if idea.user.first_name %}
                            {{ idea.user.profile.full_name }}
                        {% else %}
                           {{ idea.user.username }}
                        {% endif %}
                        </h4>
                        <h6>Via {{ idea.get_via_display }}
                            {% if idea.get_via_display == "Twitter" %}
                            <i class="icon-twitter"></i>
                            {% elif idea.get_via_display == "Text" %}
                            <i class="icon-mobile-phone"></i>
                            {% elif idea.get_via_display == "Web" %}
                            <i class="icon-globe"></i>
                            {% elif idea.get_via_display == "Instagram" %}
                            <i class="icon-instagram"></i>
                            {% endif %}
                            â€¢ Floated {{ idea.floated|ago }}
                          </h6>
                          <p>{{ idea.tagline }}</p>
                           <p><a href="#"><i class="icon-heart-empty icon-border"> Like</i></a>&nbsp;&nbsp;
                           <a href="#"><i class="icon-comment-alt icon-border"> Comment</i></a></p>
                      </div>
                    </div>
                  </li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>

    </div>
{% endblock body %}

{% block map_js %}
<script>
    var lot = L.geoJson(null, {
        style: selectedLotStyle
    }).addTo(map);
        

    var lot_url = '{% url "api-lot-detail" lot.id %}' + '?format=json'

    $.getJSON(lot_url, function(data){
          map.fire('dataloading');
          lot.addData(data);
          var center = new L.LatLng({{ lot.coord.y }}, {{ lot.coord.x }});
          map.setView(center, 18);

          var content = '<h4>{{ lot.address }}</h4>';

          L.circleMarker(center, { fillOpacity: 0, opacity: 0}).addTo(map).bindLabel(content, {direction: 'left'}).showLabel();

          var bounds = map.getBounds();
          var vacant_url = '{% url "api-lot-list" %}' + '?bbox' + bounds.toBBoxString() + '&format=json';
          
          $.getJSON(vacant_url, function(data){
            vacant  = L.geoJson(data, {
              style: lotStyle,
              onEachFeature: onEachFeature
            }).addTo(map);
            map.fire('dataload');
        });
    });

    function onEachFeature(feature, layer) {
      if (feature.properties) {
          var html = '<h4>' + feature.properties.address +'</h4>' +
                 '<p><a class="btn btn-primary" href="' + Urls.lotxlot_lot_detail(feature.properties.id, feature.properties.slug) + '">View</a>';
          layer.bindPopup(html);
          if (feature.properties.idea_set.length > 0) {
            var bounds = layer.getBounds();
            var center = bounds.getCenter();
            var labelText = '<a href="' + Urls.lotxlot_lot_detail(feature.properties.id, feature.properties.slug) +
                            '"><i class="icon-comment-alt icon-4x">' +
                            '<h4> ' + 
                             feature.properties.idea_set.length + '</h4></i></a>'
           var labelTextSelected = '<a href="' + Urls.lotxlot_lot_detail(feature.properties.id, feature.properties.slug) +
                            '"><i class="icon-comment icon-4x">' +
                            '<h4> ' + 
                             feature.properties.idea_set.length + '</h4></i></a>'
            marker = L.circleMarker(center, { fillOpacity: 0, opacity: 0}).addTo(map);
            if (feature.properties.id == {{ lot.id }}) {
                marker.bindLabel(labelTextSelected, { noHide: true, className: 'idea-label-selected' }).showLabel();
            } else {
                marker.bindLabel(labelText, { noHide: true, className: 'idea-label' }).showLabel();
            }
          }
      }
    }

</script>
{% endblock map_js %}
