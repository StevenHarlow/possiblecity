{% extends "philadelphia/base.html" %}
{% load possiblecity_tags %}
{% load staticfiles %}
{% block layout %}
<div class="page-content">
    <div id="map" style="position:absolute; width:100%; height:100%">
    </div>
    <div id="map-status" class="status">
        Loading Map Features...
    </div>
</div>

</div>
{% endblock layout %}
{% block js_local %}
<script src="{{ STATIC_URL }}js/libs/leaflet-plugins/layer/tile/Bing.js"></script>
<script>
    // Initialize the map object
    var map = L.map('map', {
        maxZoom: 20,
        minZoom: 11
       
    });
    
    // Prep the background tile layer
    var streetUrl = 'http://api.tiles.mapbox.com/v3/dmeehan.map-sued82zn/{z}/{x}/{y}.png';
    var streetAttr = '';
    
    var streets = L.tileLayer(streetUrl, {
        attribution: streetAttr,
        maxZoom: 20
    }).addTo(map);

    var satellite = new L.BingLayer("Anqm0F_JjIZvT0P3abS6KONpaBaKuTnITRrnYuiJCE0WOhH6ZbE4DzeT6brvKVR5");

    // Set the center on Philadelphia
    var philadelphia = new L.LatLng(39.9522, -75.1642);
    map.setView(philadelphia, 12);
    
                 
    var availableLotsPolys = L.geoJson(null, {
                    onEachFeature: function(feature, layer) {
                        url = '{% url lot_detail 0 %}'.replace (0, feature.properties.id);
                        html = '<p><strong><a href="' + url + '">' 
                               + feature.properties.address 
                               + '</a></strong></p>'
                               + '<p>FOR SALE!</p>';         
                        layer.bindPopup(html);
                        layer.setStyle(availableStyle);
                    },
                });
                
    var unavailableLotsPolys = L.geoJson(null, {
                    onEachFeature: function(feature, layer) {
                        url = '{% url lot_detail 0 %}'.replace (0, feature.properties.id);
                        html = '<p><strong><a href="' + url + '">' 
                               + feature.properties.address 
                               + '</a></strong></p>';     
                        layer.bindPopup(html);
                        layer.setStyle(polyStyle);
                    },
                });
                
    var availableStyle = {
        "fillColor":"#e8db00",
        "fillOpacity": 0.5,
        "opacity": 1,
        "weight": 2,
        "color":"#e8db00",
        //"dashArray": "4 2"
    };
    
    var unavailableStyle = {
        "fillColor":"#ff00ff",
        "fillOpacity": 0.5,
        "opacity": 1.0,
        "weight": 2,
        "color":"#ff00ff",
        "dashArray": "4 2"
    };
    
    
    var baselayers = {
        "Streets": streets
        //"Aerial": satellite
    };
                
    var overlays = {
        "Public Lots for Sale": availableLotsPolys,
        "Other Public Lots": unavailableLotsPolys
    };
    
    
    var layerPanel = L.control.layers(baselayers, overlays, {
        collapsed: false
    })

    

    $.getJSON('{% url available_lots_polys %}', function(data){
        availableLotsPolys.addData(data.features).addTo(map);
        $('#map-status').fadeOut('slow');
        map.fitBounds(polys.getBounds());
    });
    
    $.getJSON('{% url unavailable_lots_polys %}', function(data){
        unavailableLotsPolys.addData(data.features).addTo(map);
    });
    
    map.on('zoomend', onZoomend);
    
    function onZoomend(){
       if (map.getZoom()>=17) {
           map.removeLayer(streets);
           map.addLayer(satellite);
       };

       if(map.getZoom()<17){
           map.removeLayer(satellite);
           map.addLayer(streets);
       };

    };
</script>
{% endblock js_local %}
