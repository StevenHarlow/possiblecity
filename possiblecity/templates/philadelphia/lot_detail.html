{% extends "philadelphia/base.html" %}
{% load possiblecity_tags %}
{% load staticfiles %}
{% load humanize %}
{% block layout %}
<div class="page-content">
    <div id="map" style="height:600px; width: 100%">
    </div>
    <div id="map-status" class="status" style="display:none">
        Loading Map Features...
    </div>
    <article class="lot">
        <section class="details">
            <h1>{{ lot.address|capsentence }}</h1>
            <ul>
               <li><span class="label">Size:</span><span class="data">{{ lot.parcel.shape_area|floatformat:"0"|intcomma }} Square Feet</span></li>
               <li><span class="label">Status:</span><span class="data">{% if lot.is_vacant %}Vacant{% else %}Occupied{% endif %}
               {% if lot.has_vacancy_license %} | Vacancy License{% endif %}
               {% if lot.has_vacancy_violation %} | Vacancy Violation{% endif %}</span></li>
               <li><span class="label">Ownership:</span><span class="data">{% if lot.is_public %}Public{% else %}Private{% endif %}</span></li>
               <li><span class="label">Availability:</span><span class="data">{% if lot.is_available %}For sale{% endif %}</span></li>
               <li><span class="label">Price:</span><span class="data">{% if lot.papl_data.PRICE %}${{ lot.papl_data.PRICE|intcomma }}{% else %}No Longer Available{% endif %}</span></li>
            </ul>
            {% if lot.papl_data.PRICE %}
            <a class="button" href="http://secure.phila.gov/PAPLPublicWeb/AddAsset.aspx?AssetID={{ lot.papl_data.ASSET_ID }}">Express Interest</a>
            <p class="note">The button above will take you to the City of Philadelphia's website, where you can express interest in purchasing the lot.</p>
            {% endif %}
        </section>
    </article>
</div>
{% endblock layout %}
{% block js_local %}
<script src="{{ STATIC_URL }}js/libs/leaflet-plugins/layer/tile/Bing.js"></script>
<script>
    // Initialize the map object
    var map = new L.Map('map', {
        zoomControl: false,
        doubleClickZoom: false,
        maxZoom: 21,
        minZoom: 11
    });
    
    // Prep the background tile layer
    var tileUrl = 'http://api.tiles.mapbox.com/v3/dmeehan.map-sued82zn/{z}/{x}/{y}.png';
    var tileAttribution = '';
    
    var satellite = new L.BingLayer("Anqm0F_JjIZvT0P3abS6KONpaBaKuTnITRrnYuiJCE0WOhH6ZbE4DzeT6brvKVR5");

    var streets = L.tileLayer(tileUrl, {
        attribution: tileAttribution,
    });
    
    
    // Set the center on Philadelphia
    var philadelphia = new L.LatLng(39.9522, -75.1642);
    map.setView(philadelphia, 15);
    
    map.addLayer(satellite);

    var geoj = {};
    
    var polyStyle = {
        "fillColor":"#e8db00",
        "fillOpacity": 0.2,
        "opacity": 1.0,
        "weight": 4,
        "color":"#e8db00",
        //"dashArray": "4 2"
    };
    
    var myStyle = {
        "fillColor": "#ff0000",
        "opacity": 1.0,
        "weight": 1,
        "color":"#000000",
        "dashArray": "2 2"
    };

    var myLayer = L.geoJson(null, {
        style: polyStyle
    }).addTo(map);
    
    $.getJSON('{% url geo_lot_detail lot.id %}', function(data){
          myLayer.addData(data);
          map.fitBounds(myLayer.getBounds());
          map.panBy([-300, -50]);
          //zoom = map.getZoom();
          //newZoom = 18
          //map.setZoom(newZoom);
    });
    
    map.on('zoomend', onZoomend);

    function onZoomend(){
       if (map.getZoom()>=17) {
           map.removeLayer(streets);
           map.addLayer(satellite);
       };

       if(map.getZoom()<17){
           map.removeLayer(satellite);
           map.addLayer(streets);
       };

    };
</script>
{% endblock js_local %}
