{% extends "philadelphia/base.html" %}
{% block layout %}
<div class="page-content" style="position:relative; top:100px">
	<div id="map" style="height:600px; width: 100%">
    </div>
    <div id="map-status" class="status" style="display:none">
        Loading Map Features...
    </div>
</div>
{% endblock layout %}
{% block js_local %}
<script src="{{ STATIC_URL }}js/libs/leaflet-plugins/layer/tile/Bing.js"></script>
<script>
    // Initialize the map object
    var map = L.map('map');
    
    // Prep the background tile layer
    var tileUrl = 'http://api.tiles.mapbox.com/v3/dmeehan.map-sued82zn/{z}/{x}/{y}.png';
    var tileAttribution = '';
    
    L.tileLayer(tileUrl, {
       attribution: tileAttribution,
    }).addTo(map);


    // Locate and set center
    // XMin: -8380165.3987
    // YMin: 4846635.811
    // XMax: -8344035.7458 
    // YMax: 4886006.8845
    var philadelphia = new L.LatLng(39.9522, -75.1642);
    var southWest = new L.LatLng(39.87, -75.28);
    var northEast = new L.LatLng(40.14, -74.96);
    var phlBounds = new L.LatLngBounds(southWest, northEast);

    map.locate();
    map.setView(philadelphia, 16);

    var lotStyle = {
        "fillColor":"#e8db00",
        "fillOpacity": 0.2,
        "opacity": 1.0,
        "weight": 2,
        "color":"#e8db00",
    };

    var lotLayer = L.geoJson(null, {
                    onEachFeature: function(feature, layer) {
                        url = '{% url "lot_detail" 0 %}'.replace (0, feature.properties.id);
                        html = '<p><strong><a href="' + url + '">' 
                               + feature.properties.address 
                               + '</a></strong></p>';        
                        layer.bindPopup(html);
                        layer.setStyle(lotStyle);
                    },
                });
    
    function onLocationFound(e) {
        if (phlBounds.contains(e.latlng)) {
           center = e.latlng
           alert('inbounds');
        } else {
           center = philadelphia
           alert('out of bounds');
        }
        map.setView(center, 16);
        L.marker(center).addTo(map);
        alert(map.getBounds().toBBoxString());
        bounds = map.getBounds().toBBoxString();
        var url = '{% url "api_lots_vacant" %}?bbox=' + bounds + '&format=json'
    
        $.getJSON(url, function(data){
            lotLayer.addData(data.features).addTo(map);
            $('#map-status').fadeOut('slow');
            map.fitBounds(lotLayer.getBounds());
        });
    }

    map.on('locationfound', onLocationFound);

    function onLocationError(e) {
        alert(e.message);
    }

    map.on('locationerror', onLocationError); 

    bounds = map.getBounds().toBBoxString();

    

    

    
</script>
{% endblock js_local %}
