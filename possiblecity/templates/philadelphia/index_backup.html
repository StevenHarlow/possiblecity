{% extends "philadelphia/base.html" %}
{% load possiblecity_tags %}
{% load staticfiles %}
{% block layout %}
<div class="page-content">
    <div id="map" style="position:absolute; width:100%; height:100%">
    </div>
    <div id="map-status" class="status">
        Loading Map Features...
    </div>
</div>

</div>
{% endblock layout %}
{% block js_local %}
<script src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
<script>
    // Initialize the map object
    var map = new L.Map('map');
    
    // Prep the background tile layer
    var streetUrl = 'http://api.tiles.mapbox.com/v3/dmeehan.map-sued82zn/{z}/{x}/{y}.png';
    var streetAttr = '';
    
    var streets = L.tileLayer(streetUrl, {
        attribution: streetAttr,
        minZoom: 10,
        maxZoom: 21
    }).addTo(map);

    var satUrl = 'http://oatile{s}.mqcdn.com/naip/{z}/{x}/{y}.jpg';
    var satAttr = 'Tiles Courtesy of <a href="http://www.mapquest.com/">MapQuest</a> &mdash; Portions Courtesy NASA/JPL-Caltech and U.S. Depart. of Agriculture, Farm Service Agency ';

    var satellite = L.tileLayer(satUrl, {
        attribution: satAttr,
        minZoom: 10,
        maxZoom: 21
    });
    
    // Set the center on Philadelphia
    var philadelphia = new L.LatLng(39.9522, -75.1642);
    map.setView(philadelphia, 12);
    
    var availableLotsPoints = L.geoJson(null, {
                     pointToLayer: function(feature, latlng) {
                         return L.circleMarker(latlng, pointStyle);
                     }
                 });
                 
    var availableLotsPolys = L.geoJson(null, {
                    onEachFeature: function(feature, layer) {
                        url = '{% url lot_detail 0 %}'.replace (0, feature.properties.id);
                        html = '<p><strong><a href="' + url + '">' 
                               + feature.properties.address 
                               + '</a></strong></p>'
                               + '<p>FOR SALE!</p>';         
                        layer.bindPopup(html);
                        layer.setStyle(availableStyle);
                    },
                });
                
    var unavailableLotsPolys = L.geoJson(null, {
                    onEachFeature: function(feature, layer) {
                        url = '{% url lot_detail 0 %}'.replace (0, feature.properties.id);
                        html = '<p><strong><a href="' + url + '">' 
                               + feature.properties.address 
                               + '</a></strong></p>';     
                        layer.bindPopup(html);
                        layer.setStyle(polyStyle);
                    },
                });
                
    var privateLotsPolys = L.geoJson(null, {
                    onEachFeature: function(feature, layer) {
                        url = '{% url lot_detail 0 %}'.replace (0, feature.properties.id);
                        html = '<p><strong><a href="' + url + '">' 
                               + feature.properties.address 
                               + '</a></strong></p>'        
                        layer.bindPopup(html);
                        layer.setStyle(polyStyle);
                    },
                });
    
    // Set a marker style for circleMarkers
    var pointStyle = {
        radius: 1,
        fillColor: "#ff00ff",
        color: "#ff00ff",
        weight: 1,
        opacity: 1,
        fillOpacity: 1.0
    };
    
    var polyStyle = {
        "fillColor":"#e8db00",
        "fillOpacity": 0.5,
        "opacity": 1,
        "weight": 1,
        "color":"#e8db00",
        //"dashArray": "4 2"
    };

    
    var availableStyle = {
        "fillColor":"#e8db00",
        "fillOpacity": 0.5,
        "opacity": 1,
        "weight": 2,
        "color":"#e8db00",
        //"dashArray": "4 2"
    };
    
    var unavailableStyle = {
        "fillColor":"#ff00ff",
        "fillOpacity": 0.5,
        "opacity": 1.0,
        "weight": 2,
        "color":"#ff00ff",
        //"dashArray": "4 2"
    };
    
    var privateStyle = {
        "fillColor":"#00ffff",
        "fillOpacity": 0.5,
        "opacity": 1.0,
        "weight": 2,
        "color":"#00ffff",
        //"dashArray": "4 2"
    };
    
    
    //$.getJSON('{% url available_lots_points %}', function(data){
        //points.addData(data.features).addTo(map);
        //map.fitBounds(points.getBounds());
    //});
    
    
    var baselayers = {
        "Streets": streets,
        "Aerial": satellite
    };
                
    var overlays = {
        "Public Lots for Sale": availableLotsPolys,
        "Other Public Lots": unavailableLotsPolys
    };
    
    
    var layerPanel = L.control.layers(baselayers, overlays, {
        collapsed: false
    })

    

    $.getJSON('{% url available_lots_polys %}', function(data){
        availableLotsPolys.addData(data.features).addTo(map);
        $('#map-status').fadeOut('slow');
        map.fitBounds(polys.getBounds());
    });
    
    $.getJSON('{% url unavailable_lots_polys %}', function(data){
        unavailableLotsPolys.addData(data.features).addTo(map);
        //$('#map-status').fadeOut('slow');
        //map.fitBounds(polys.getBounds());
    });
    
    //$.getJSON('{% url private_lots_polys %}', function(data){
        //privateLotsPolys.addData(data.features).addTo(map);
        //$('#map-status').fadeOut('slow');
        //map.addControl(layerPanel)
        //map.fitBounds(polys.getBounds());
    //});
    
    map.on('zoomend', onZoomend);
    
    
    function onZoomend(){
       if (map.getZoom()>=18) {
           //map.removeLayer(points);
           //map.addLayer(polys);
           map.removeLayer(streets);
           map.addLayer(satellite);
           //map.addControl(tileControl);
       };

       if(map.getZoom()<18){
           //map.removeLayer(polys);
           //map.addLayer(points);
           map.removeLayer(satellite);
           map.addLayer(streets);
           //map.removeControl(tileControl);
       };

    };
</script>
{% endblock js_local %}
